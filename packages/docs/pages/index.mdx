import { Callout } from "nextra-theme-docs";

# Bunnygram 🐇📬

Simple task scheduling for Next.js

<Callout type="warning" emoji="⚠️">
  Note that these docs are still being written. If you find inaccuracies or
  anything missing, please open an issue on GitHub!
</Callout>

## Introduction

Bunnygram is a task scheduler for Next.js. You might need it if you want to defer a computationally expensive or long-running task in the background.

You can choose from multiple adapters, including [QStash](https://docs.upstash.com/qstash), with more coming soon.

It borrows from patterns introduced by a similar library [Quirrel](https://github.com/quirrel-dev/quirrel), which was one of the first to make adding task/job queues to Next.js more developer friendly.

## Install

```sh
pnpm add bunnygram
```

You can also use `yarn` or `npm`.

## Setup

Suppose you wanted to send your user an email when they signed up. Here's how you can kick off the email job in the background with Bunnygram:

### Step 1: Define your scheduler

Put your scheduler config somewhere e.g. `tasks/send-email.ts`:

```ts
// tasks/send-email.ts

import { makeConfig } from "bunnygram";

interface JobPayload {
  emailAddress: string;
}

interface JobResponse {
  status: boolean;
}

export const sendEmail = makeConfig<JobPayload, JobResponse>({
  // the path this API route will be accessible on
  route: "/api/send-email",

  // if you're just testing on localhost, you also need to supply the baseUrl here:
  // baseUrl: "http://localhost:3000",

  // the default adapter is BasicAdapter, but you can specify the one you want
  // adapter: BasicAdapter()
});
```

A few important things to note here:

- Notice how we specify the payload and response for the job we are about to write (more on that in step 2). This allows for better intellisense.
- We specify the API route the scheduler will be available on.
- There is some optional config. Crucially, if you are testing on `localhost` you have to specify the `baseUrl` explicitly.

### Step 2: Set up a Next.js API route

```ts
// pages/api/send-email.ts

import { onReceive } from "bunnygram";
import { sendEmail } from "@/tasks/send-email";
import { mailchimp } from "example-email-api";

export default onReceive({
  config: sendEmail,
  // the job to run
  // autocomplete 👇 on the payload
  job: async ({ payload }) => {
    const { emailAddress } = payload;
    await mailchimp.send({
      // ... use the payload
    });
    // 👇 autocomplete on the response
    return {
      status: true,
    };
  },
});

// we need to disable body parser, because some adapters need the raw request body for verification
// you can read more here https://nextjs.org/docs/api-routes/request-helpers
export const config = {
  api: {
    bodyParser: false,
  },
};
```

### Step 3: Send a message

Send a message to the receiver from anywhere else inside our Next.js app:

```tsx
// src/pages/index.tsx

import { send } from "bunnygram";
import { sendEmail } from "@/tasks/send-email";

export default function Home() {
  const runJob = async () => {
    await send({
      config: sendEmail,
      // 👇 autocomplete on the payload
      payload: {
        emailAddress: "hello@gmail.com",
      },
    });
  };

  return <button onClick={runJob}>Send email</button>;
}
```
